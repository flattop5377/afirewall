##
# IPV6 Rules.  These match the IPV4 rules
#
#
table ip6 a-firewall-inbound-ipv6 {

{% if sshd %}{% include 'ipv6/sshd.rules' %}{% endif %}

  #############################################################################
  #
  ## DEFAULT rules
  #
  # Drop everything
  #
  #############################################################################

  ##
  # Drop all traffic that hasn't been accepted by priority 10 filters
  #
  chain DROP_BY_DEFAULT {
    type filter hook input priority 20; policy drop;

{% if sshd %}    ip protocol tcp jump ACCEPT_SSH
{% endif %}
    ip protocol icmp jump VALID_ICMP

  }

  #############################################################################
  #
  ## ICMP Rules
  #
  #############################################################################

  ##
  # ICMP rate limit per source
  #
  set icmp_rate_limit {
    type ipv6_addr
    timeout 60s
    flags dynamic
  }

  ##
  # Only allow valid ICMP inbound traffix.
  #   Drop all traffix except what's specifically allowed
  #
  # Sources:
  #   https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml
  chain VALID_ICMP {
    icmp type echo-reply update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type destination-unreachable update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type source-quench update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type redirect update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type echo-request update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type time-exceeded update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type parameter-problem update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type timestamp-request update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type timestamp-reply update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type info-request update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type info-reply update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type address-mask-request update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type address-mask-reply update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type router-advertisement update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
    icmp type router-solicitation update @icmp_rate_limit { ip6 saddr limit rate 10/second } accept
  }

  #############################################################################
  #
  ## Block Private Subnet Spoofing
  #
  #############################################################################

  # Count the number of packets dropped by the SPOOFING chain
  counter NUMBER_OF_SPOOFS_DROPPED {
  }

  ##
  # We should not receive any traffix from private subnets on a Public
  # interface
  #
  # Reference:
  #   https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml
  chain SPOOFING {
    type filter hook input priority mangle; policy accept;

{% for network in SPOOFED_NETWORKS %}    ip saddr {{ network }} counter name NUMBER_OF_SPOOFS_DROPPED drop
{% endfor %}
  }

  # Count the number of packets dropped by the INVALID_FLAGS chain
  counter NUMBER_OF_INVALID_FLAGS_DROPPED {
  }

  #############################################################################
  #
  ## Invalid TCP Flag rules
  #
  #############################################################################

  ##
  # Accept all traffix except invalid traffix.
  #
  # Based on (it's insane that in 2024 it's necessary to currate the references that are so hard to find)
  #   apf-firewall: https://www.rfxn.com/projects/advanced-policy-firewall/
  #   blog: https://www.sobyte.net/post/2022-04/understanding-netfilter-and-iptables/:
  #   netfileter wiki: https://wiki.nftables.org/wiki-nftables/index.php/Netfilter_hooks
  #   message thread: https://git.netfilter.org/nftables/log/include/expression.h?id=4e0026dc8d8693aaf2caf8df6d657a116734e84e&showmsg=1
  #   netfilter (iptables 2.4) documentation: https://netfilter.org/documentation/HOWTO/packet-filtering-HOWTO-7.html
  #   netfiler quick reference: https://wiki.nftables.org/wiki-nftables/index.php/Quick_reference-nftables_in_10_minutes#Ct
  #   blog: https://andreafortuna.org/2019/05/08/iptables-a-simple-cheatsheet/
  chain INVALID_FLAGS {
    type filter hook input priority raw; policy accept;
      # Drop segments that have no TCP flags: https://www.rfc-editor.org/rfc/rfc9293.html
      # FLAGS  = 00000000
      # MASK   = 11111111
      # RESULT = 00000000
      tcp flags == 0x0 counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have both FIN and SYN flags set
      # FLAGS  = 00000011
      # MASK   = 00000011
      # RESULT = 00000011
      tcp flags == 0x3 counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have FIN, SYN, RST, ACK, URG flags set (REDUNDANT)
      # FLAGS  = 00110111
      # MASK   = 00110111
      # RESULT = 00110111
      # tcp flags == 0x37 counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have URG, ACK, PSH, RST, SYN, FIN flags set (REDUNDANT)
      # FLAGS  = 00111111
      # MASK   = 00111111
      # RESULT = 00111111
      # tcp flags == 0x3F counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have all TCP flags set (REDUNDANT)
      # FLAGS  = 11111111
      # MASK   = 11111111
      # RESULT = 11111111
      # tcp flags == 0x255 counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have both SYN and RST flags set
      # FLAGS  = 00000110
      # MASK   = 00000110
      # RESULT = 00000110
      tcp flags == 0x6 counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have both FIN and RST flags set
      # FLAGS  = 00000101
      # MASK   = 00000101
      # RESULT = 00000101
      tcp flags == 0x5 counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that only have FIN
      # FLAGS  = 00000001
      # MASK   = 11111111
      # RESULT = 00000001
      tcp flags == 0x1 counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have FIN without ACK (REDUNDANT)
      # FLAGS  = 00000001
      # MASK   = 00010001
      # RESULT = 00000001
      # tcp flags fin / fin,ack counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have URG without ACK
      # FLAGS  = 00100000
      # MASK   = 00110000
      # RESULT = 00100000
      tcp flags urg / urg,ack counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have PSH without ACK
      # FLAGS  = 00001000
      # MASK   = 00011000
      # RESULT = 00001000
      tcp flags psh / psh,ack counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have FIN, PSH, and URG flags set
      # FLAGS  = 00101001
      # MASK   = 00101001
      # RESULT = 00101001
      tcp flags == 0x29 counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop conntrack segments with INVALID state
      # https://wiki.nftables.org/wiki-nftables/index.php/Matching_connection_tracking_stateful_metainformation
      ct state invalid counter drop
  }

  # Count the number of packets with a source or destination port of 0
  counter NUMBER_OF_PORT_ZERO_SEGMENTS_DROPPED {
  }

  chain PORT_ZERO {
    type filter hook input priority raw;

      tcp dport 0 counter name NUMBER_OF_PORT_ZERO_SEGMENTS_DROPPED drop
      tcp sport 0 counter name NUMBER_OF_PORT_ZERO_SEGMENTS_DROPPED drop
      udp dport 0 counter name NUMBER_OF_PORT_ZERO_SEGMENTS_DROPPED drop
      udp sport 0 counter name NUMBER_OF_PORT_ZERO_SEGMENTS_DROPPED drop
  }
}

table ip6 a-firewall-outbound-ipv6 {

  #############################################################################
  #
  ## Drop by default
  #
  # If the output traffic isn't specifically accpeted by priority 10 rules,
  # this rule will drop the traffic.  EXCEPT if the connection is established.
  #
  #############################################################################
  chain DROP_BY_DEFAULT {
    type filter hook output priority filter; policy drop;

{% if sshd %}    tcp sport 22 ct state established counter accept
{% endif %}
  }

  # Count the number of packets dropped by the INVALID_FLAGS chain
  counter NUMBER_OF_INVALID_FLAGS_DROPPED {
  }

  chain INVALID_FLAGS {
    type filter hook output priority filter;

      # Drop segments that have no TCP flags: https://www.rfc-editor.org/rfc/rfc9293.html
      # FLAGS  = 00000000
      # MASK   = 11111111
      # RESULT = 00000000
      tcp flags == 0x0 counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have both FIN and SYN flags set
      # FLAGS  = 00000011
      # MASK   = 00000011
      # RESULT = 00000011
      tcp flags == 0x3 counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have both SYN and RST flags set
      # FLAGS  = 00000110
      # MASK   = 00000110
      # RESULT = 00000110
      tcp flags == 0x6 counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have both FIN and RST flags set
      # FLAGS  = 00000101
      # MASK   = 00000101
      # RESULT = 00000101
      tcp flags == 0x5 counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have FIN without ACK
      # FLAGS  = 00000001
      # MASK   = 00010001
      # RESULT = 00000001
      tcp flags fin / fin,ack counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have URG without ACK
      # FLAGS  = 00100000
      # MASK   = 00110000
      # RESULT = 00100000
      tcp flags urg / urg,ack counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop segments that have PSH without ACK
      # FLAGS  = 00001000
      # MASK   = 00011000
      # RESULT = 00001000
      tcp flags psh / psh,ack counter name NUMBER_OF_INVALID_FLAGS_DROPPED drop

      # Drop conntrack segments with INVALID state
      ct state invalid counter drop
  }
}

